<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWI St. Augustine Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{api_key}}&callback=initMap&libraries=places&loading=async" async defer></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #sidenav { height: 100%; width: 250px; position: fixed; top: 0; left: 0; background-color: #fafee9; padding-top: 20px; color: black; overflow-y: auto; }
        #map { margin-left: 250px; width: calc(100% - 250px); height: 100vh; }
        #sidenav form { margin: 10px; }
        #sidenav input, button { margin-top: 10px; padding: 8px; font-size: 16px; width: calc(100% - 20px); border-radius: 5px; }
        #saveButton { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #saveButton:hover { background-color: #45a049; }
    </style>
    <script>
        let map, selectedMarker = null, selectedLocation = null;

        function initMap() {
            const uwiLocation = { lat: 10.6417, lng: -61.3995 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: uwiLocation,
                zoom: 15,
                mapTypeId: "roadmap",
                restriction: {
                    latLngBounds: {
                        north: 10.6455, south: 10.6340, west: -61.4070, east: -61.3920
                    },
                    strictBounds: true
                }
            });

            google.maps.event.addListenerOnce(map, 'idle', function() {
                loadSavedLocations();
            });
        }

        function loadSavedLocations() {
            fetch('/get_locations')
                .then(response => response.json())
                .then(data => {
                    console.log("Locations received:", data);
                    if (data.locations.length > 0) {
                        data.locations.forEach(location => addMarker(location));
                    }
                })
                .catch(error => console.error('Error loading locations:', error));
        }

        function addMarker(location) {
            console.log("Adding marker for:", location);
            const marker = new google.maps.Marker({
                position: { lat: location.latitude, lng: location.longitude },
                map: map,
                title: location.name
            });

            marker.addListener('click', function() {
                selectedMarker = marker;
                selectedLocation = location;
                document.getElementById("locationNameInput").value = location.name || "";

                if (location.id) {
                    window.location.href = `/app/${location.id}`;
                }
            });
        }

        function saveLocation(event) {
    event.preventDefault(); 

    if (!selectedLocation) {
        alert("Please click on an existing marker before saving.");
        return;
    }

    const customName = document.getElementById("locationNameInput").value.trim();
    if (!customName) {
        alert("Please enter a custom name for the location.");
        return;
    }

    fetch('/save_location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: customName,
            latitude: selectedLocation.latitude,
            longitude: selectedLocation.longitude,
            locationid: selectedLocation.id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Location saved successfully!");

            
            const listDiv = document.getElementById("savedLocations");
            const newEntry = document.createElement("p");
            newEntry.textContent = customName;
            listDiv.appendChild(newEntry);

            window.location.reload();
        } else {
            alert("Error saving location");
        }
    })
    .catch(error => console.error('Error:', error));
}

    </script>
</head>
<body>
    <div id="sidenav">
        <div style="margin: 0 10px 20px 10px;">
            <form action="/logout" method="GET">
                <button type="submit" style="width: 100%; padding: 8px; font-size: 16px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Logout
                </button>
            </form>
        </div>
        <form action="/save_location/{{location_id}}" method="POST">
            <input type="text" id="locationNameInput" value="{{location_name}}" name="name" placeholder="Enter a custom name" required />
            <button type="submit" id="saveButton">Save Location</button>
        </form>

        <div style="margin-left: 10px;">
            <h3>Saved Locations</h3>
            <div id="savedLocations">
                {% if locations %}
                    {% for location in locations %}
                        <p>{{ location.marker_name }}</p>
                    {% endfor %}
                {% else %}
                    <p>No locations saved yet.</p>
                {% endif %}
            </div>
        </div>
        
    </div>
    <div id="map"></div>
</body>
</html>
