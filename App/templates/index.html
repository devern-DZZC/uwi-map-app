<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWI St. Augustine Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{api_key}}&callback=initMap&libraries=places&loading=async" async defer></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #sidenav { height: 100%; width: 300px; position: fixed; top: 0; left: 0; background-color: #fafee9; padding-top: 20px; color: black; overflow-y: auto; }
        #map { margin-left: 300px; width: calc(100% - 300px); height: 100vh; }
        
        #flashed-messages {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999; 
            width: 80%; 
            max-width: 600px; 
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #flashed-messages .alert {
            background-color: #f2f2f2;
            color: black;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 0;
        }

        .varela-round-regular {
        font-family: "Varela Round", sans-serif;
        font-weight: 400;
        font-style: normal;
      }
      body {
        display: flex;
        min-height: 100vh;
        background-color: #3A5A40;
      }
      main {
        flex: 1 0 auto;
        padding: 2rem;
        background-color: #A3B18A;
        margin: 20px;
        border-radius: 5px;
      }
      .brand-logo {
        padding-left: 1rem;
      }
      .sidenav-trigger {
        margin: 1rem;
        color: #DAD7CD; 
      }
      .sidenav {
        background-color: #DAD7CD;
      }

      h5 {
        margin-right: 50px;
        padding: 25px;
        height: auto;
        width: auto;
        align-self: center;
        background-color: #344E41;
        color: #DAD7CD; 
        font-weight: 200;
        border-radius: 2px;
      }

      .prompt p {
        width: max-content;
        height: auto;
        margin: 5px;
        padding: 5px;
        font-size: medium;
        font-style: oblique;
        color: #3A5A40;
      }

      .prompt {
        display: flex;
        flex-direction: column;
        justify-content: center; 
        align-items: center;     
        height: 75vh;
        text-align: center;
      }

      .prompt a{
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 20px;
        cursor: pointer;
        color: #DAD7CD; 
        background-color: #A3B18A;
      }

      .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px;
      }
      .filter-buttons button {
        background: #A3B18A;
        border: 2px solid black;
        padding: 10px 20px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .filter-buttons button.active,
      .filter-buttons button:hover {
        background: #3A5A40;
        color: #DAD7CD;
      }

      .location-container {
        max-width: 400px;
        margin: 10px;
        text-align: left;
      }

      .location-item {
        display: flex;
        align-items: center;
        border: 2px solid black; 
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 15px;
        background-color: #A3B18A;
      }

      .circle {
        height: 14px;
        width: 14px;
        border: 3px solid black;
        border-radius: 50%;
        margin-right: 16px;
      }

      .sub-header {
        font-size:large;
        font-style: italic;
        font-weight: 500;
        width: 100%;
        height: 100%;
        color: #3A5A40;
      }

      .welcomemsg {
        margin: 10px;
        color:#344E41;
        font-size: small;
        font-weight: 500;
      }

      .place-info {
        margin: 10px;
        color: #344E41;
      }
    </style>
</head>
<body>
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div id="flashed-messages">
                {% for message in messages %}
                <div class="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

    <div id="route-data" data-route='{{ route | tojson | safe }}' style="display: none;"></div>

    <div id="sidenav">
        <ul id="slide-out">

            <div class= "greeting">
                <h5> WiGo </h5>
                <div class="welcomemsg">
                  <p> Hello, {{current_user.username}}</p>
                  <p> How can I guide you today? </p>
                </div>
            </div>
  
            <div class= "place-info">
                <img id="place-photo" src="placeholder.jpg" alt="Place photo" style="width:100%; margin-top:10px;" />
                <div id="place-name"> Please choose a location </div>
            </div>
            
            <form action="/save_location/{{location_id}}" method="POST">
                <input type="text" id="locationNameInput" value="{{location_name}}" name="name" placeholder="Enter a custom name" required />
                <button type="submit" id="saveButton">Save Location</button>
            </form>

            <h3 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Find Routes</h3>

            <form id="routeForm" action="/get-route" method="POST" style="display: flex; flex-direction: column; max-width: 400px; gap: 12px; padding: 16px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">
                <select id="locationRouteInput1" name="route1" required style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;">
                    <option value="">Select Location 1</option>
                    {% for location in all_locations %}
                        <option value="{{ location.id }}">{{ location.name }}</option>
                    {% endfor %}
                </select>

                <select id="locationRouteInput2" name="route2" required style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;">
                    <option value="">Select Location 2</option>
                    {% for location in all_locations %}
                        <option value="{{ location.id }}">{{ location.name }}</option>
                    {% endfor %}
                </select>

                <button type="submit" id="findRouteButton" style="padding: 10px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease;">
                    Find Route
                </button>
            </form>
      
                  <div class="filter-buttons">
                    <div class="sub-header">
                      <p> Filter By </p>
                    </div>
                    <button onclick="filterLocations('faculty')">◆ Faculties</button>
                    <button onclick="filterLocations('building')">◆ Buildings </button>
                    <button onclick="filterLocations('field')">◆ Fields </button>
                    <button onclick="filterLocations('classroom')">◆ Classrooms </button>
                    <button onclick="filterLocations('auditorium')">◆ Auditoriums </button>
                    <button onclick="filterLocations('library')">◆ Libraries </button>
                    <button onclick="filterLocations('car park')">◆ Car Parks </button>
                  </div>
      
                  <div class = "location-container">
                    <div class="sub-header">
                      <p> My Locations </p>
                    </div>
                    {% for location in current_user.locations %}
                      <div class="location-item">
                        <span class="circle"></span>
                        <p>{{ location.marker_name }}</p>
                      </div>
                    {% endfor %}
                  </div>
      
                  <div style="margin: 0 10px 20px 10px;">
                    <form action="/logout" method="GET">
                        <button type="submit" style="width: 100%; padding: 8px; font-size: 16px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Logout
                        </button>
                    </form>
                </div>
        </ul>
        
    </div>
    
    <div id="map"></div>
   
</body>

<script>
    let map, selectedMarker = null, selectedLocation = null;
    
    function initMap() {
        const uwiLocation = { lat: 10.6417, lng: -61.3995 };
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer();
        map = new google.maps.Map(document.getElementById("map"), {
            center: uwiLocation,
            zoom: 15,
            mapTypeId: "roadmap",
            restriction: {
                latLngBounds: {
                    north: 10.6455, south: 10.6340, west: -61.4070, east: -61.3920
                },
                strictBounds: true
            }
        });
        directionsRenderer.setMap(map);

        const routeDiv = document.getElementById('route-data');
        const route = JSON.parse(routeDiv.getAttribute('data-route'));

        console.log("Route data:", route);

        if (route && route.routes && route.routes[0] && route.routes[0].legs && route.routes[0].legs[0]) {
            
            const startAddress = route.routes[0].legs[0].start_address;
            const endAddress = route.routes[0].legs[0].end_address;

            const request = {
                origin: startAddress,
                destination: endAddress,
                travelMode: google.maps.TravelMode.WALKING
            };
            console.log(request)

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                }
                else
                    console.log("error")
            });
        }

        google.maps.event.addListenerOnce(map, 'idle', function() {
            loadSavedLocations();
        });
    }

    function loadSavedLocations() {
        fetch('/get_locations')
            .then(response => response.json())
            .then(data => {
                console.log("Locations received:", data);
                if (data.locations.length > 0) {
                    data.locations.forEach(location => addMarker(location));
                }
            })
            .catch(error => console.error('Error loading locations:', error));
    }

    function addMarker(location) {
        console.log("Adding marker for:", location);
        const marker = new google.maps.Marker({
            position: { lat: location.latitude, lng: location.longitude },
            map: map,
            title: location.name
        });

        marker.addListener('click', function() {
            selectedMarker = marker;
            selectedLocation = location;
            document.getElementById("locationNameInput").value = location.name || "";

            if (location.id) {
                window.location.href = `/app/${location.id}`;
            }
        });
    }

    function saveLocation(event) {
    event.preventDefault(); 

    if (!selectedLocation) {
        alert("Please click on an existing marker before saving.");
        return;
    }

    const customName = document.getElementById("locationNameInput").value.trim();
    if (!customName) {
        alert("Please enter a custom name for the location.");
        return;
    }

    fetch('/save_location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: customName,
            latitude: selectedLocation.latitude,
            longitude: selectedLocation.longitude,
            locationid: selectedLocation.id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const listDiv = document.getElementById("savedLocations");
            const newEntry = document.createElement("p");
            newEntry.textContent = customName;
            listDiv.appendChild(newEntry);
            window.location.reload();
        } else {
            alert("Error saving location");
        }
    })
    .catch(error => console.error('Error:', error));
    }
        window.onload = function() {
            const flashMessages = document.getElementById('flashed-messages');
            if (flashMessages) {
            setTimeout(() => {
                flashMessages.style.display = 'none';
            }, 5000); 
            }
        }
</script>
</html>



